# Run yq in docker to avoid a local dependency
image = $(shell ${kustomize} | ${yq} '. | select(.kind=="Deployment" or .kind=="Job" or .kind=="CronJob")' \
	| ${yq} 'select(document_index == 0) | .. | select(path | join(".") | test("\\.image$$"))' )

build::
	@#docker build -t ${image} . --progress=plain --no-cache
	docker build -t ${image} .

clean:: stop
	docker rmi -f "${image}" &> /dev/null

config::
	@echo image = ${image}

login::
	aws ecr get-login-password | docker login --username AWS --password-stdin ${REGISTRY_BASE}

push::
	docker push ${image}

repo::
	aws ecr create-repository --repository-name ${app} || true

